- Two major aspects here:
	- What do we scan?
	- How do we do it?

## What to scan?

- Depending on the size of an org, there can be hundreds, thousands, even 10s of thousands of devices
- We can't realistically scan all of them! We won't be able to do much else. We need a priority system.

### Asset criticality

- How important is an asset? What is critical to business operation?
	- Think about the impact of having this asset affected in any malicious way. Is it really bad? Then the asset is important and it goes high on the priority list.
	- Not everything is critical though. If someone steals the espresso machine from your recreation area, it doesn't affect business operations in such a meaningful way (though it'll certainly ruin the day for many). A shame, but not critical.
- Here's a rough priority system that can be used as a starting point
	1. **People**. As far as CompTIA (and anyone with half a brain) is concerned, people's lives come first in any scenario. This includes your employees, partners, suppliers, even visitors.
	2. **Tangible assets**. Servers and whatnot.
	3. **Intangible assets**. Product ideas, development plans, brand, reputation.

### Asset and inventory tracking

- This is no easy task, but it can be done with the help of dedicated tools
- Things to track for devices: type, model, SN, internal ID, location, user, value, service information (for vendor/repair)
	- Classification: grouping of devices/assets using certain characteristics
		- Usage, e.g. development/test/production environments
		- Network: what network/subnet/segment a device belongs to
		- Sensitivity (how sensitive the info contained on a device): public, private, restricted, confidential, etc.
		- Outside connections: does a device communicate with external entities such as partners? Does it store PII?
		- Financial value. More expensive tech gets higher priority too.
		- Legal requirements: what's mandatory to have up and running?
		- Contractual obligations

## Vulnerability scanning

Infrastructure Vulnerability Scanner (Nessus, OpenVAS, Qualys)
- Not `nmap`!
- A piece of software that scans hosts, network devices, endpoints, servers, etc.
- Looks for vulns in the following aspects:
	- OS version and patches
	- Services
	- Configuration
	- Network shares that may be accessible
	- User accounts
	- Weak security policies

### Scoping

- The **scope** describes the extent of the scan
- What systems and networks are included? 
- What technical measures will be used to test whether systems are present on the network?
- What tests will be performed against systems discovered by the scanner?
- Know all this before you commence the scan
- Compliance might have to be considered
	- If you process credit cards, you have to be PCI DSS compliant
	- Make sure all systems involved in credit card processing are within the scope of the required scan

### Methodology, techniques, considerations

- **Mapping and enumeration**
	- Inventory devices, services, versions, plugins, etc
	- `nmap` is used internally at this stage by many scanners
- **Passive scanning**
	- Look for public info
	- Capture network traffic
	- **Don't get involved in any way**
	- Don't interact with the target
	- Zero impact on network and services
	- Mostly cannot be detected
- **Active scanning**
	- Directly interact with target, make a connection, hit it with some traffic
	- Actively send requests and analyze answers
	- It's visible and it's noisy
	- Can create performance issues and downtime, stuff can crash
	- **Do it outside the working hours!**
	- Easily detected
- **Credentialed scanning**
	- Receive a valid user account for the purposes of vuln scanning, log into certain hosts, perform automated checks
	- Very in-depth due to the insider point of view - no need to scan every port to figure out what services are running, no trial and error
	- Highest level of detail
	- Similar to a situation an insider threat is in
- **Non-credentialed scanning**
	- No user account provided
	- Probing/testing hosts and networks to gather info
	- Outside hacker's point of view
	- **Exam**: remember that this always uses more bandwidth
	- Scanning software has to go through a lot more trial and error, sometimes even brute forcing
	- Jeopardizes functionality of machines and services - can crash
	- Not too accurate
- **Server-based scanning**
	- Not all scanning is done from some central location on the network
	- Connect to the server and scan
	- Can be credentialed or non-credentialed
- **Agent-based**
	- An agent is installed on each host
	- Administered from a central console
	- Run scans on hosts
	- Report findings back to the central console
	- Acts like a backdoor for scanning utilities
	- Advantages:
		- Credentialed by default (has to be installed on the host, so it runs as a service)
		- Efficient resource usage - scanning is performed locally, network is only needed to commucate findings
		- Works with offline devices, findings are reported upon next connection
	- Disadvantages:
		- Increased management overhead - must install agents before anything can be done
		- Not necessarily OS-agnostic, especially when it comes to network devices
		- Vulnerable backdoor - opens up an additional possible attack vector. If agent is compromised, you're in trouble
- **Internal**
	- Conducted from within the org's network, aim to identify vulns existing on internal network devices (servers, workstations, appliances, etc.)
	- What could an attacker do if they got into the network?
	- Detecting vulns that could be exploited by insiders
	- Scanning a broad range of devices, including those not directly accessible from the internet
	- Identifying misconfigurations, unnecessary services, insecure internal practices
	- Providing a more complete view of the internal network's security posture
- **External**
	- Conducted from the outside of the org's network, focused on identifying vulns in externally facing assets: web/email servers, firewalls, etc.
	- Concerns everything an external attacker might exploit to breach the perimeter and gain access to the internal network
	- Simulating the perspective of an outside attacker, with appropriate visibility
	- Prioritizing assets that are the most at-risk (public-facing web apps, remote access services)
- **Sensitivity levels**
	- Pay careful attention to these
	- Sensitivity levels are determined by settings - what types of checks the scanner will perform, should it be customized to ensure the scan meets its objectives?
	- Consider false positives (don't want too many) and system disruption
	- Start with a template, adjust based on the scope
	- Templates may be custom-developed
	- Efficiency can be improved via plug-ins - a lot of scanners are extensible

### Risks associated with scanning activities

- System performance impact
	- Vuln scanning is a resource-intensive process
	- System performance can be degraded, especially if scans are being run during a busy time
- System instability
	- Operations may be inadvertently disrupted by vuln scanning
	- Especially true for poorly configured systems, legacy systems, or anything with existing bugs
- False positives and false negatives (see [09](https://github.com/ordsec/cysa-notes/blob/master/09%20Vulnerability%20scanning%20results%20%26%20CVSS%20scores.md))
- Sensitive data exposure
	- This data is often involved in scans (for instance, system information, network structures, etc.)
	- The results of the scan have to be properly secured - they are also sensitive data
	- We don't want any of this exposed
- Compliance issues
	- Scans may be performed and documented in a specific way, depending on the regulatory environment
	- If this is not done, compliance issues will ensue

### Segmentation (from the vuln scanning point of view)

- The key term is **reachability**!
- Most networks will have VLANs/subnets/VPN connections
- Scanners have to be able to reach everything in order to work correctly, no matter the method/technique involved
	- For agent-based, agents have to be able to reach the central host
- Proper routing/firewall rules have to be in place prior to scanning
- IDPS has to be adjusted so that it doesn't throw alerts or block authorized scanning
	- **Whitelisting**
- Consider a dedicated **management network**
	- Separate VLAN or physical network designed specially for managing, controlling, and scanning your unfrastructure

### Frequency of vuln scanning

- Depends on risk appetite: the bigger, the less frequently you'll scan
- Severe disruptions can be caused by scanning
- Licensing limitations of scanning software
- What are the time constraints? Scanning can really take a while
- As a rule of thumb, though, scan when...
	- There's some change on the network: additions, updates, etc., whether hardware or software
	- It's required by regulations
	- After a breach. Have a clear understanding of what the vulnerability was that caused it

### Choosing a scanner

- Free vs paid
	- Paid relies on proprietary vuln DBs, which can be better, also proprietary scanning methods
- General-purpose vs specialized (e.g. for web apps or for mobile devices)
- **Nessus**
	- Essential: free, up to 16 hosts
	- Professional: paid, unlimited IPs, best for pentesters
	- Tenable.io: unlimited Nessus scanners, offers RBAC, best for companies of whatever size
	- Lots of scan profiles, can create your own
- **OpenVAS**
	- Free and open-source
	- Developed from the Nessus codebase before Nessus became paid
	- Now part of the Greenbone Security suite
- **Qualys**
	- Infrastructure vuln manager
	- **Cloud-based**!
	- Based on sensors installed all over your network, including cloud
	- Sensors can be deployed as agents or as VMs, passive and out-of-band possible

### Scanner maintenance

- Just like everything else, vuln scanners have to stay up to date
- **Vulnerability feeds** are a crucial part - always keep them current
	- This is usually done automatically, but verifying it manually is never a bad idea

---

### Exam

This is a very important topic overall! Be able to discuss asset classification, vuln scanners and their aspects: active/passive, credentialed/non-credentialed, agent-based. Remember scanner troubleshooting: reachability is key, also what a management network is. Know scanning tools: Nessus, OpenVAS, Qualys; know differences between them and various flavours of Nessus with use cases.

---

# From the Sybex book

### Server and endpoint vulns

- Missing patches
	- Self-evident - your stuff is not patched to the latest version
	- Remediation: install those patches, silly! In an enterprise setting, have a test environment to make sure you're not breaking anything
	- For mobile devices, MDM solutions take care of pushing out updates. White-listing apps is possible to make sure nothing else runs and to maintain all approved apps
- Unsupported OS's and applications
	- After EOSL, an OS or an app receives no further updates, so you're running the risk of running vulnerable software with no patches available
	- Remediation: upgrade to the latest version - easy to say, hard to do. If it's not possible, isolate or at least segment away all systems that run unsupported stuff
- Buffer overflows - discussed in 19
- Privilege escalation - discussed in 19 (Dirty COW) and 23 (rootkits)
- Arbitrary code execution
	- The attacker attempts to run code of their choice on the target system
	- Worse if that code can run with administrative privileges
	- Usually detected by scans if known
	- Remediation: patching
- Insecure protocol use
	- HTTP instead of HTTPS, FTP instead of SFTP/FTPS, plaintext versions of IMAP, LDAP, etc - they were all designed without security in mind
	- Remediation: find a secure version (a lot of them use TLS), tunnel through IPSec
- Debugging modes
	- App gets developed and deployed, debug mode (used by developers) is not disabled
	- Discloses a lot of info about the app that should be hidden
	- Remediation: only use debug mode in testing, on systems dedicated for that purpose; disable debug mode everywhere else

### Network vulns

- Missing firmware updates
- TLS issues 
	- Outdated TLS version (or using SSL, which is deprecated)
		- Current is 1.2-1.3, disallow anything else
	- Insecure cipher use
		- Some ciphers are vulnerable or too weak, so they shouldn't be used
		- RC2, RC4, DES, IDEA, TDES/3DES, NULL - no good! Disable those
	- Certificate problems
		- Mismatches between the name of the cert and the name of the server - sorta like a fake ID you "borrow" from a friend
		- Cert expiration
		- Unknown CA - captive portals with self-signed certs
		- All these are red flags - users shouldn't proceed further on such sites
- DNS issues
	- DNS has no built-in security, so it's vulnerable to many things
	- BOF, missing patches, RCE can happen here too
	- DNS-specific problems also exist
		- Amplification - attacker sends spoofed DNS requests to a DNS server that are designed to elicit a response that's much larger in size than the original request, the response is sent to the spoofed IP; can cause a DoS condition for the victim (who gets the response) 
- Internal IP disclosure
	- Disclosing the DNS server's private IP on the network
	- Can be in HTTP headers
	- Happens due to poor configuration - server is not aware of NAT in use
- VPN issues
	- Use patched VPN software, make sure ciphers are strong, use the correct IPSec functionality
- Virtualization vulns - virtualization adds more admin overhead, so it should be conducted in a very organized fashion
	- VM escape
	- Management interface access - hypervisor management software should be kept very safe
	- Virtual host patching - see patches and updates, pertains to host OS's and hypervisor software
	- Virtual guest issues - ditto, for guest OS's
	- Virtual network issues - virtual networks should be maintained with the same level of attention to security as physical networks. Use virtual firewalls and isolation to keep everything in check
- IoT vulns: see 40 for SCADA, ICS, PLC's, embedded systems, RTOS, SoC, FPGA, CAN
- Web application vulns - we have to communicate with web devs to prevent these
	- Injection attacks - remediated via proper input validation for the most part
		- SQLi: additional remediation is implementing least privilege on database access and using stored procedures, also WAF
		- XSS - **exam! Know all types**
			- Persistent aka stored: attack code is stored on a server
			- Reflected: attacker tricks user into sending the attack to the server as part of a query string, relies on clicking on a link. The server then sends the attack back tot he user (reflecting it), then malicious code executes
			- DOM-based: occurs within a database maintained by the user's web browser, therefore never seen by the remote web server because it happens on the user's computer entirely
			- Additional remediation: WAF
		- Directory traversal
		- IDOR
		- LFI/RFI
		- CSRF
	- Authentication vulns
		- Password reuse - should be regular against password spraying and credential stuffing
		- Impersonation: attacker tries to misrepresent themselves as a legitimate user, relies on stuff like OAuth open redirects. 
			- Remediation: stronger session handling, refer to [OWASP Session Management Cheatsheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
		- MitM
			- Remediation: end-to-end encryption of sessions and network links
		- Session hijacking - taking over an already existing session by acquiring its key or related cookies
			- Remediation: secure all session/cookie data, only transmit it securely