- Signatures worked great - up to a point
- Malware created every day and every hour - and its aim is to avoid detection
- We need to keep up with this and stay on top of the game

### Community effort

- People working together to identify and spread the knowledge about new and emerging malware
- Intel can be submitted online (on VirusTotal, for instance), giving vendors data that they can analyse - also good for checking if a file/hash/URL is malicious according to some reputable sources
- A naming convention has been generated also as part of the community efforts, so that we can know what kind of malware we're talking about
	- [Caro's naming convention](http://www.caro.org/articles/naming.html)
	- [MAEC naming conventions for STIX compatibility](https://maecproject.github.io/about-maec/)
	- [YARA rules](https://yara.readthedocs.io/en/stable/) - standardizing naming conventions **AND** detection rules (how to write these rules in a uniform manner)

### Sandboxing

- Similar to dynamic analysis
- Running malware inside an isolated virtual environment, letting it do its thing, learning from how it behaves
- This is also known as **detonating** the malware
- A sandbox can monitor:
	- Changes to system files
	- Changes to running processes and services, or whether new services are started by the malware
	- Network activity: ports being open? Something getting downloaded? Outbound connections? Destinations might prove useful as well
	- Low-level system calls - does it try to access the hardware in an abnormal way?
	- File creation, change, deletion during execution - or perhaps it archives and encrypts everything?
	- Creating scheduled tasks 
		- Sometimes malware uses this to avoid being studied in a sandbox environment - persisting itself in task manager or `crontab` to run later
		- Antimalware solutions for sandboxes can use time acceleration techniques to mitigate this
- Sandboxing solutions:
	- [Cuckoo](https://cuckoosandbox.org/) is a real famous one - **exam!** It's free and open-source
	- Others exist by many known vendors
- Sandoxes are usually well-isolated VM's, but...
	- **Keep hypervisor software vulnerabilities in mind!**
	- Not often encountered, but some malware may attempt to exploit the hypervisor itself

### Reverse engineering

- Similar to static analysis, except we don't have the actual code
- Dissecting the malware to figure out how it was built in the first place
- **Decompiler**
	- Ideally, takes an executable file and determines its high-level source code (C/C++, Java, etc.)
	- Not always possible: while you may be able to get something Java's class files, C/C++ decompiling can easily give you absolutely nothing
	- Malware creators use code obfuscation techniques before compiling, making original code very difficult to read 
	- Pseudocode can also be generated by some decompilers - explaining program logic without the need for actual code; it's more of a language-agnostic solution
- **Disassembler**
	- Ideally, takes binary code and converts it into assembly code, which consists of CPU instructions and is quite hard to follow
	- Machine code can be used to properly identify file types, which is better than relying on file extensions that can easily be spoofed
	- Every file has a binary header, sometimes called the "magic number", which is used by antimalware solutions so that they're not fooled by a false file extension; identifies the actual contents of the file
		- Use a [file signature database](https://www.garykessler.net/library/file_sigs.html) to search for exact values
		- These headers can also be masked or faked by malware creators, though, but it has to be correct at execution time
- Read: [Decompilation vs Disassembly](https://www.hex-rays.com/decompiler/decompilation_vs_disassembly/)
- **String searching**
	- Looking for certain sequences of characters
	- Static strings are often stored together in program code - as one block
	- Whenever the sequence is made out of printable/readable characters, it's worth looking at
	- Can reveal variable names, file names, names of processes the malware is trying to attack, domains it's trying to reach, keys, etc.
	- Use the `strings` command for this - run it on a binary, see all readable strings there are
- **Program packers**
	- A packed program is like a self-extracting archive
	- Evades the `strings` utility
	- Used by malware to make it more difficult to match a signature
	- Some malware can re-compress itself with different algorithms
	- To analyze, detonate it in a sandbox, let it unpack, see what it does 

### Exploit techniques

- Methods used by malware to attack its target
- **Viruses**
	- Infect files on the hard drive by attaching some secondary executable code to those files and waiting for someone to open that file
	- Require user interaction
	- We can fight them using static signatures and antivirus solutions
- **Worms**
	- Propagate over the network
	- Run in memory before they attempt to use the network
	- Does not require user interaction
	- Looks for specific vulns it can exploit in order to spread
- **Fileless malware**
	- Does not need to be persisted on the disk (similar to worms)
	- We can use signatures to identify them, but we look for them in memory
	- **Exam!** Shellcode: executable code passed through a script in a request or some other type of protocol
	- Shellcode often acts as a dropper/downloader, which goes and grabs the rest of malicious code for execution
	- It's easier to trick a user into clicking a link that encodes a tiny downloader than to have them run a whole executable that has to be a file (antiviruses aren't so easily tricked)
	- The malware that subsequently gets downloaded is usually for maintaining access - like a RAT
- **Code injection**
	- Another thing shellcode can do
	- System processes are usually targeted for this - malware can run its own injected code with the privileges of the victim process, if successful; this gives the malware way too much power if privs are high enough
	- Methods include:
		- Masquerading: replacing usual application files with malicious ones to run the bad code
		- DLL injection
		- DLL sideloading
		- Phantom DLL hijacking: dropping a DLL in the place of a missing one, which the app will then attempt to locate and load 
		- Process hollowing: starts an empty-ish process without any malware in it (doesn't trigger any AV alerts), then dynamically changing and updating the process to run malicious code
	- Code injection looks not only for vulnerable processes for privesc, but also for antivirus programs themselves - or forensic tools, decompilers, etc. It attempts to disable those before doing the dirt.
- **Living off the land**
	- It's a practice of using existing tools on the infected machine in order to perform malicious tasks
	- Sometimes it's enough to just run PowerShell/Bash/Python to do bad things
	- [LOLBAS](https://lolbas-project.github.io/#)
	- [GTFOBins](https://gtfobins.github.io/)

---

### Exam

Be very familiar with all malware analysis techniques described above, know the tools of the trade, be able to discuss exploit techniques for different types of malware. 